<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE NumericUnderscores #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">{-|
This module implements the main abstract logic of the Internet Computer. It
assumes a pure and abstracted view on Canisters (provided by &quot;IC.Canister&quot;),
and deals with abstract requests ('CallRequest', 'QueryRequest', ...), so HTTP
and CBOR-level processing has already happened.
-}</span><span>
</span><span id="line-24"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IC.Ref</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier">IC</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier">CallRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#callerOfCallRequest"><span class="hs-identifier">callerOfCallRequest</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier">QueryRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier">ReadStateRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#RequestStatus"><span class="hs-identifier">RequestStatus</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReqResponse"><span class="hs-identifier">ReqResponse</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier">CallResponse</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#initialIC"><span class="hs-identifier">initialIC</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier">authCallRequest</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier">authQueryRequest</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier">authReadStateRequest</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#submitRequest"><span class="hs-identifier">submitRequest</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#handleQuery"><span class="hs-identifier">handleQuery</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#handleReadState"><span class="hs-identifier">handleReadState</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#runStep"><span class="hs-identifier">runStep</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier">runToCompletion</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier">processSystemTasks</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><span class="hs-comment">-- $ Exported for use as a library, e.g. in testing</span></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier">setAllTimesTo</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#createEmptyCanister"><span class="hs-identifier">createEmptyCanister</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="hs-comment">-- $ Exported merely for debug introspection</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier">CallContext</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Message"><span class="hs-identifier">Message</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier">CanState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallOrigin"><span class="hs-identifier">CallOrigin</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#EntryPoint"><span class="hs-identifier">EntryPoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#RunStatus"><span class="hs-identifier">RunStatus</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanisterContent"><span class="hs-identifier">CanisterContent</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">where</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.html"><span class="hs-identifier">Data.Row</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/bytestring-0.11.4.0/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html"><span class="hs-identifier">Control.Monad.State.Class</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Sequence.html"><span class="hs-identifier">Data.Sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Sequence.Internal.html#Seq"><span class="hs-identifier">Seq</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#toList"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.html"><span class="hs-identifier">Codec.Candid</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.html"><span class="hs-identifier">Data.Row</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator">(.!)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Types.html"><span class="hs-identifier">IC.Types</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Canister.html"><span class="hs-identifier">IC.Canister</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.CBOR.Utils.html"><span class="hs-identifier">IC.CBOR.Utils</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Id.Fresh.html"><span class="hs-identifier">IC.Id.Fresh</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Utils.html"><span class="hs-identifier">IC.Utils</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Management.html"><span class="hs-identifier">IC.Management</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HashTree.html"><span class="hs-identifier">IC.HashTree</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HashTree.html#Blob"><span class="hs-identifier">Blob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.html"><span class="hs-identifier">IC.Certificate</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html"><span class="hs-identifier">IC.Certificate.Value</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.CBOR.html"><span class="hs-identifier">IC.Certificate.CBOR</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Crypto.html"><span class="hs-identifier">IC.Crypto</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Ref.Management.html"><span class="hs-identifier">IC.Ref.Management</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Ref.Types.html"><span class="hs-identifier">IC.Ref.Types</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- Request handling</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="annot"><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-type">findRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span id="findRequest"><span class="annot"><span class="annottext">findRequest :: Blob -&gt; IC -&gt; Maybe (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-var hs-var">findRequest</span></a></span></span><span> </span><span id="local-6989586621679401089"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679401089"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679401088"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679401088"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679401089"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679401088"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span id="local-6989586621679401521"><span class="annot"><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-type">setReqStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401521"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401521"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-92"></span><span id="setReqStatus"><span class="annot"><span class="annottext">setReqStatus :: forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var hs-var">setReqStatus</span></a></span></span><span> </span><span id="local-6989586621679401080"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679401080"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679401079"><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679401079"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401077"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679401077"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679401077"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">requests :: Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#adjust"><span class="hs-identifier hs-var">M.adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679401075"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679401075"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679401074"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401074"><span class="hs-identifier hs-var">ecid</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679401075"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679401079"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401074"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679401080"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679401077"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="annot"><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-type">calleeOfCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span>
</span><span id="line-96"></span><span id="calleeOfCallRequest"><span class="annot"><span class="annottext">calleeOfCallRequest :: CallRequest -&gt; CanisterId
</span><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-var hs-var">calleeOfCallRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679401070"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401070"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401070"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">-- Canister handling</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span id="local-6989586621679401506"><span class="annot"><a href="IC.Ref.html#doesCanisterExist"><span class="hs-identifier hs-type">doesCanisterExist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401506"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401506"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-102"></span><span id="doesCanisterExist"><span class="annot"><span class="annottext">doesCanisterExist :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#doesCanisterExist"><span class="hs-identifier hs-var hs-var">doesCanisterExist</span></a></span></span><span> </span><span id="local-6989586621679401057"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401057"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401057"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">Maybe CanState
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">Maybe CanState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span id="local-6989586621679401050"><span class="annot"><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-type">isCanisterRunning</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401050"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401050"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-109"></span><span id="isCanisterRunning"><span class="annot"><span class="annottext">isCanisterRunning :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var hs-var">isCanisterRunning</span></a></span></span><span> </span><span id="local-6989586621679401036"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401036"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m RunStatus
</span><a href="IC.Ref.Types.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679401036"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">RunStatus
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- Authentication and authorization of requests</span><span>
</span><span id="line-114"></span><span class="hs-comment">--</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- The envelope has already been validated. So this includes</span><span>
</span><span id="line-116"></span><span class="hs-comment">--  * Comparing the envelope validity with the contents</span><span>
</span><span id="line-117"></span><span class="hs-comment">--  * Authorization of the sender</span><span>
</span><span id="line-118"></span><span class="hs-comment">--  * ingress message inspection</span><span>
</span><span id="line-119"></span><span class="hs-comment">--  * checking the correct effective id</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-keyword">type</span><span> </span><span id="RequestValidation"><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-var">RequestValidation</span></a></span></span><span> </span><span id="local-6989586621679401033"><span class="annot"><a href="#local-6989586621679401033"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#MonadError"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ValidationError"><span class="hs-identifier hs-type">ValidationError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401033"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401033"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span id="local-6989586621679401487"><span class="annot"><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier hs-type">authCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-124"></span><span id="authCallRequest"><span class="annot"><span class="annottext">authCallRequest :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
Timestamp -&gt; CanisterId -&gt; EnvValidity -&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier hs-var hs-var">authCallRequest</span></a></span></span><span> </span><span id="local-6989586621679400993"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400993"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679400992"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400992"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679400991"><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400991"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621679400990"><span class="annot"><span class="annottext">r :: CallRequest
</span><a href="#local-6989586621679400990"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679400989"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400989"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679400988"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400988"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679400987"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400987"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679400986"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400986"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679400985"><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679400985"><span class="hs-identifier hs-var">subnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Maybe Subnet)
</span><a href="IC.Ref.Types.html#getSubnetFromCanisterId%27"><span class="hs-identifier hs-var">getSubnetFromCanisterId'</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400992"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679400985"><span class="hs-identifier hs-var">subnet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot route request with effective canister id &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400992"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400992"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400989"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400987"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400986"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621679400977"><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400977"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/transformers-0.5.6.2/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred Timestamp
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400991"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400993"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400991"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400988"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400991"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400989"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400977"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679400972"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400972"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400972"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-133"></span><span>                </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). RequestValidation m =&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-var">inspectIngress</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679400990"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span id="local-6989586621679401461"><span class="annot"><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier hs-type">authQueryRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401461"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401461"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-137"></span><span id="authQueryRequest"><span class="annot"><span class="annottext">authQueryRequest :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
Timestamp -&gt; CanisterId -&gt; EnvValidity -&gt; QueryRequest -&gt; m ()
</span><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier hs-var hs-var">authQueryRequest</span></a></span></span><span> </span><span id="local-6989586621679400939"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400939"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679400938"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400938"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679400937"><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400937"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span id="local-6989586621679400935"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400935"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679400934"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400934"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679400933"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400933"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679400932"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400932"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621679400931"><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679400931"><span class="hs-identifier hs-var">subnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Maybe Subnet)
</span><a href="IC.Ref.Types.html#getSubnetFromCanisterId%27"><span class="hs-identifier hs-var">getSubnetFromCanisterId'</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400938"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679400931"><span class="hs-identifier hs-var">subnet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot route request with effective canister id &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400938"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400938"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400935"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400933"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400932"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span id="local-6989586621679400930"><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400930"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/transformers-0.5.6.2/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred Timestamp
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400937"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400939"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-143"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400937"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400934"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-144"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400937"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400935"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400930"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679400929"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400929"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400929"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-146"></span><span>                </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span id="local-6989586621679401458"><span class="annot"><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier hs-type">authReadStateRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-149"></span><span id="authReadStateRequest"><span class="annot"><span class="annottext">authReadStateRequest :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
Timestamp -&gt; CanisterId -&gt; EnvValidity -&gt; ReadStateRequest -&gt; m ()
</span><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier hs-var hs-var">authReadStateRequest</span></a></span></span><span> </span><span id="local-6989586621679400811"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400811"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679400810"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679400809"><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span id="local-6989586621679400807"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679400806"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400806"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621679400805"><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679400805"><span class="hs-identifier hs-var">subnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Maybe Subnet)
</span><a href="IC.Ref.Types.html#getSubnetFromCanisterId%27"><span class="hs-identifier hs-var">getSubnetFromCanisterId'</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679400805"><span class="hs-identifier hs-var">subnet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot route request with effective canister id &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621679400804"><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400804"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/transformers-0.5.6.2/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred Timestamp
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400811"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400804"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679400803"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400803"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400803"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-156"></span><span>                </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400802"><span class="annot"><span class="annottext">request_ids :: Path
</span><a href="#local-6989586621679400802"><span class="hs-identifier hs-var hs-var">request_ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.OldList.html#nub"><span class="hs-identifier hs-var">nub</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Path -&gt; Path
</span><a href="#local-6989586621679400799"><span class="hs-identifier hs-var">request_id</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400806"><span class="hs-identifier hs-var">paths</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; CallId
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621679400802"><span class="hs-identifier hs-var">request_ids</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Can only request one request ID in request_status paths.&quot;</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">-- Implement ACL for read requests here</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400806"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;subnet&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400794"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400794"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;module_hash&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; CanisterId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400794"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400791"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400791"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;controllers&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; CanisterId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400791"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400790"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400790"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;metadata&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400789"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400789"><span class="hs-identifier hs-var">name</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; CanisterId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400790"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>        </span><span id="local-6989586621679400788"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400788"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Maybe Text
</span><a href="IC.Utils.html#fromUtf8"><span class="hs-identifier hs-var">fromUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400789"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid utf8 in metadata path&quot;</span></span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679400786"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400786"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400786"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-173"></span><span>        </span><span id="local-6989586621679400785"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400785"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#doesCanisterExist"><span class="hs-identifier hs-var">doesCanisterExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-174"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400785"><span class="hs-identifier hs-var">ex</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>          </span><span id="local-6989586621679400784"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679400784"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-176"></span><span>          </span><span id="local-6989586621679400782"><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679400782"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Set CanisterId)
</span><a href="IC.Ref.Types.html#getControllers"><span class="hs-identifier hs-var">getControllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-177"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400788"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Text &#8614; (Bool, Blob)
</span><a href="IC.Canister.html#metadata"><span class="hs-identifier hs-var">metadata</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679400784"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>            </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- private</span><span>
</span><span id="line-179"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">S.member</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679400782"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-180"></span><span>                </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;User is not authorized to read this metadata field&quot;</span></span><span>
</span><span id="line-181"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Bool, Blob)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- public or absent</span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400778"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400778"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Int64
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/bytestring-0.11.4.0/src/Data.ByteString.Lazy.html#length"><span class="hs-identifier hs-var">BS.length</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400778"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Request IDs must be 32 bytes in length.&quot;</span></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400775"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400775"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>                            </span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; IC -&gt; Maybe (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-var">findRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400775"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-185"></span><span>          </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400774"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679400774"><span class="hs-identifier hs-var">ar</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400773"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400773"><span class="hs-identifier hs-var">ecid'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400810"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400773"><span class="hs-identifier hs-var">ecid'</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest -&gt; CanisterId
</span><a href="IC.Ref.Types.html#callerOfCallRequest"><span class="hs-identifier hs-var">callerOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679400774"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-188"></span><span>              </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;User is not authorized to read this request status&quot;</span></span><span>
</span><span id="line-189"></span><span>            </span><span id="local-6989586621679400772"><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400772"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/transformers-0.5.6.2/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>              </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest -&gt; CanisterId
</span><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-var">calleeOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679400774"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679400772"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679400771"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400771"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Show.html#unpack"><span class="hs-identifier hs-var">T.unpack</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400771"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-192"></span><span>                        </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>          </span><span class="annot"><span class="annottext">Maybe (CallRequest, (RequestStatus, CanisterId))
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>      </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;User is not authorized to read unspecified state paths&quot;</span></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><a href="#local-6989586621679400799"><span class="hs-identifier hs-type">request_id</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HashTree.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.HashTree.html#Label"><span class="hs-identifier hs-type">Label</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621679400799"><span class="annot"><span class="annottext">request_id :: Path -&gt; Path
</span><a href="#local-6989586621679400799"><span class="hs-identifier hs-var hs-var">request_id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679400769"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400769"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400769"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="#local-6989586621679400799"><span class="hs-identifier hs-var">request_id</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">-- Synchronous requests</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span id="local-6989586621679401433"><span class="annot"><a href="IC.Ref.html#handleQuery"><span class="hs-identifier hs-type">handleQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-203"></span><span id="handleQuery"><span class="annot"><span class="annottext">handleQuery :: forall (m :: * -&gt; *).
ICM m =&gt;
Timestamp -&gt; QueryRequest -&gt; m ReqResponse
</span><a href="IC.Ref.html#handleQuery"><span class="hs-identifier hs-var hs-var">handleQuery</span></a></span></span><span> </span><span id="local-6989586621679400754"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400754"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span id="local-6989586621679400753"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679400752"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400752"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679400751"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400751"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679400750"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400750"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; ReqResponse
</span><a href="IC.Ref.Types.html#QueryResponse"><span class="hs-identifier hs-var">QueryResponse</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; CallResponse
</span><a href="IC.Ref.Types.html#canisterRejected"><span class="hs-identifier hs-var">canisterRejected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621679400689"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400689"><span class="hs-identifier hs-var">is_running</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var">isCanisterRunning</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400689"><span class="hs-identifier hs-var">is_running</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister is stopped&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_STOPPED"><span class="hs-identifier hs-var">EC_CANISTER_STOPPED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>    </span><span id="local-6989586621679400684"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400684"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400684"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister is empty&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_EMPTY"><span class="hs-identifier hs-var">EC_CANISTER_EMPTY</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679400680"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679400680"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m WasmState
</span><a href="IC.Ref.Types.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621679400678"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679400678"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span id="local-6989586621679400677"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400677"><span class="hs-identifier hs-var">certificate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; m Blob
</span><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-var">getDataCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400754"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621679400675"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679400675"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Env
</span><a href="IC.Ref.Types.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400753"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400673"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621679400673"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679400675"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">env_certificate :: Maybe Blob
</span><a href="IC.Types.html#env_certificate"><span class="hs-identifier hs-var">env_certificate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400677"><span class="hs-identifier hs-var">certificate</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621679400671"><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679400671"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400751"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; String &#8614; (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
</span><a href="IC.Canister.html#query_methods"><span class="hs-identifier hs-var">query_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679400678"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m (Maybe a) -&gt; m a -&gt; m a
</span><a href="IC.Ref.Types.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;query method does not exist&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_METHOD_NOT_FOUND"><span class="hs-identifier hs-var">EC_METHOD_NOT_FOUND</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679400671"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400752"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679400673"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400750"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679400680"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679400666"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400666"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400666"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_TRAPPED"><span class="hs-identifier hs-var">EC_CANISTER_TRAPPED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400662"><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679400662"><span class="hs-identifier hs-var">rc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400661"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400661"><span class="hs-identifier hs-var">rm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679400662"><span class="hs-identifier hs-var">rc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400661"><span class="hs-identifier hs-var">rm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_REJECTED"><span class="hs-identifier hs-var">EC_CANISTER_REJECTED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679400658"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400658"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallResponse
</span><a href="IC.Ref.Types.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400658"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span id="local-6989586621679401406"><span class="annot"><a href="IC.Ref.html#handleReadState"><span class="hs-identifier hs-type">handleReadState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401406"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">T.Text</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-225"></span><span id="handleReadState"><span class="annot"><span class="annottext">handleReadState :: forall (m :: * -&gt; *).
ICM m =&gt;
Timestamp
-&gt; CanisterId -&gt; ReadStateRequest -&gt; m (Either Text ReqResponse)
</span><a href="IC.Ref.html#handleReadState"><span class="hs-identifier hs-var hs-var">handleReadState</span></a></span></span><span> </span><span id="local-6989586621679400646"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400646"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679400645"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400645"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span id="local-6989586621679400644"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400644"><span class="hs-identifier hs-var">_sender</span></a></span></span><span> </span><span id="local-6989586621679400643"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400643"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400642"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400642"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ErrorCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400642"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- NB: Already authorized in authSyncRequest</span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621679400626"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679400626"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var">getPrunedCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400646"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400645"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400643"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; ReqResponse
</span><a href="IC.Ref.Types.html#ReadStateResponse"><span class="hs-identifier hs-var">ReadStateResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679400626"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span id="local-6989586621679401467"><span class="annot"><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-type">checkEffectiveCanisterID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#MethodName"><span class="hs-identifier hs-type">MethodName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401467"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-231"></span><span id="checkEffectiveCanisterID"><span class="annot"><span class="annottext">checkEffectiveCanisterID :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; String -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var hs-var">checkEffectiveCanisterID</span></a></span></span><span> </span><span id="local-6989586621679400529"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400529"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679400528"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400528"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679400527"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400527"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679400526"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400526"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400528"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400527"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400527"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;create_canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister_info&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;raw_rand&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;http_request&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ecdsa_public_key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sign_with_ecdsa&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>         </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_REJECT"><span class="hs-identifier hs-var">RC_CANISTER_REJECT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400527"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; cannot be invoked via ingress calls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#decode"><span class="hs-identifier hs-var">Codec.Candid.decode</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#Rec"><span class="hs-identifier hs-type">R.Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Internal.html#.%3D%3D"><span class="hs-operator hs-type">R..==</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Data.html#Principal"><span class="hs-identifier hs-type">Principal</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400526"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-237"></span><span>                        </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679400520"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400520"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>                          </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_REJECT"><span class="hs-identifier hs-var">RC_CANISTER_REJECT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Candid failed to decode: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400520"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>                        </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679400519"><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679400519"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>                          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400529"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Principal -&gt; CanisterId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679400519"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator hs-var">.!</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;canister_id&quot; a =&gt; a
</span><span class="">#canister_id</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400529"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400528"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span id="local-6989586621679401442"><span class="annot"><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-type">assertEffectiveCanisterId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401442"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401442"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-244"></span><span id="assertEffectiveCanisterId"><span class="annot"><span class="annottext">assertEffectiveCanisterId :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var hs-var">assertEffectiveCanisterId</span></a></span></span><span> </span><span id="local-6989586621679400508"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400508"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679400507"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400507"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400508"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400507"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ValidationError
</span><a href="IC.Ref.Types.html#HTTPError"><span class="hs-identifier hs-var">HTTPError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expected effective canister_id &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400507"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, got &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; String
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400508"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span id="local-6989586621679401462"><span class="annot"><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-type">inspectIngress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-249"></span><span id="inspectIngress"><span class="annot"><span class="annottext">inspectIngress :: forall (m :: * -&gt; *). RequestValidation m =&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-var hs-var">inspectIngress</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679400387"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679400386"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400386"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679400385"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679400384"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400384"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-keyword">if</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;provisional_top_up_canister&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;raw_rand&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;deposit_cycles&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;http_request&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ecdsa_public_key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sign_with_ecdsa&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_REJECT"><span class="hs-identifier hs-var">RC_CANISTER_REJECT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; cannot be invoked via ingress calls&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="IC.Management.html#managementMethods"><span class="hs-identifier hs-var">managementMethods</span></a></span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#decode"><span class="hs-identifier hs-var">decode</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#Rec"><span class="hs-identifier hs-type">R.Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Internal.html#.%3D%3D"><span class="hs-operator hs-type">R..==</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Data.html#Principal"><span class="hs-identifier hs-type">Principal</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400384"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-257"></span><span>        </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679400382"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400382"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_REJECT"><span class="hs-identifier hs-var">RC_CANISTER_REJECT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Candid failed to decode: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400382"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679400381"><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679400381"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400380"><span class="annot"><span class="annottext">canister_id :: CanisterId
</span><a href="#local-6989586621679400380"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; CanisterId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679400381"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator hs-var">.!</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;canister_id&quot; a =&gt; a
</span><span class="">#canister_id</span></span><span>
</span><span id="line-260"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679400379"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400379"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400379"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; String
</span><a href="IC.Ref.Types.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-261"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400380"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-262"></span><span>            </span><span id="local-6989586621679400367"><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679400367"><span class="hs-identifier hs-var">controllers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Set CanisterId)
</span><a href="IC.Ref.Types.html#getControllers"><span class="hs-identifier hs-var">getControllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400380"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400386"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Set.Internal.html#member"><span class="hs-operator hs-var">`S.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679400367"><span class="hs-identifier hs-var">controllers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-264"></span><span>                </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Wrong sender&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unknown management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679400366"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400366"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400366"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; String
</span><a href="IC.Ref.Types.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span id="local-6989586621679400355"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400355"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679400355"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister is empty&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679400354"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679400354"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m WasmState
</span><a href="IC.Ref.Types.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621679400353"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679400353"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621679400352"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679400352"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Env
</span><a href="IC.Ref.Types.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; String -&gt; CanisterId -&gt; Env -&gt; Blob -&gt; WasmState -&gt; TrapOr Bool
</span><a href="IC.Canister.html#inspect_message"><span class="hs-identifier hs-var">inspect_message</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679400353"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400386"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679400352"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400384"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679400354"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679400350"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400350"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister trapped in inspect_message: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400350"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; ValidationError
</span><a href="IC.Ref.Types.html#ExecutionError"><span class="hs-identifier hs-var">ExecutionError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_REJECT"><span class="hs-identifier hs-var">RC_CANISTER_REJECT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;message not accepted by inspect_message&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- The state tree</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="annot"><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-type">stateTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span><span>
</span><span id="line-284"></span><span id="stateTree"><span class="annot"><span class="annottext">stateTree :: Timestamp -&gt; IC -&gt; LabeledTree
</span><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-var hs-var">stateTree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679400347"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679400347"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679400346"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400346"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679400347"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;subnet&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b} {c} {d}.
(CanisterId, b, c, d, [(Word64, Word64)]) -&gt; Map Blob LabeledTree
</span><a href="#local-6989586621679400342"><span class="hs-identifier hs-var">subnet_tree</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; [Subnet]
</span><a href="IC.Ref.Types.html#subnets"><span class="hs-identifier hs-var">subnets</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400346"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400340"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679400339"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-290"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679400337"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;received&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-292"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679400337"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;processing&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#Replied"><span class="hs-identifier hs-type">Replied</span></a></span><span> </span><span id="local-6989586621679400334"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400334"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679400337"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;replied&quot;</span></span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;reply&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400334"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#Rejected"><span class="hs-identifier hs-type">Rejected</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400332"><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679400332"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400331"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400331"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400330"><span class="annot"><span class="annottext">Maybe ErrorCode
</span><a href="#local-6989586621679400330"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-298"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;error_code&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; String
</span><a href="IC.Types.html#errorCode"><span class="hs-identifier hs-var">errorCode</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679400328"><span class="hs-identifier hs-var">code</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679400328"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679400328"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#maybeToList"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ErrorCode
</span><a href="#local-6989586621679400330"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-299"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679400337"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;rejected&quot;</span></span><span>
</span><span id="line-300"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;reject_code&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode -&gt; Natural
</span><a href="IC.Types.html#rejectCode"><span class="hs-identifier hs-var">rejectCode</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679400332"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;reject_message&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400331"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400340"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400340"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400339"><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679400339"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400346"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400324"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;certified_data&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Blob
</span><a href="IC.Ref.Types.html#certified_data"><span class="hs-identifier hs-var">certified_data</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679400322"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;controllers&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CanisterId] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodePrincipalList"><span class="hs-identifier hs-var">encodePrincipalList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Set a -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">S.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Set CanisterId
</span><a href="IC.Ref.Types.html#controllers"><span class="hs-identifier hs-var">controllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679400322"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>      </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.Types.html#content"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679400322"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><span class="annottext">Maybe CanisterContent
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679400317"><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679400317"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;metadata&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-314"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Blob
</span><a href="IC.Utils.html#toUtf8"><span class="hs-identifier hs-var">toUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400315"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400314"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400315"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679400315"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679400314"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400314"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Text &#8614; (Bool, Blob)
</span><a href="IC.Canister.html#metadata"><span class="hs-identifier hs-var">metadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.Types.html#can_mod"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679400317"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-315"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;module_hash&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Blob
</span><a href="IC.Canister.html#raw_wasm_hash"><span class="hs-identifier hs-var">raw_wasm_hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.Types.html#can_mod"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679400317"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679400324"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400324"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400322"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679400322"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400346"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679400322"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621679400345"><span class="annot"><span class="annottext">node :: [Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Blob LabeledTree -&gt; LabeledTree
</span><a href="IC.HashTree.html#SubTrees"><span class="hs-identifier hs-var">SubTrees</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621679401346"><span class="annot"><a href="#local-6989586621679400343"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401346"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401346"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span></span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621679400343"><span class="annot"><span class="annottext">val :: forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
</span><a href="IC.HashTree.html#Value"><span class="hs-identifier hs-var">Value</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; Blob
</span><a href="IC.Certificate.Value.html#toCertVal"><span class="hs-identifier hs-var">toCertVal</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621679400337"><span class="annot"><span class="annottext">str :: Text -&gt; LabeledTree
</span><a href="#local-6989586621679400337"><span class="hs-identifier hs-var hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">T.Text</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span id="local-6989586621679400344"><span class="annot"><span class="annottext">=: :: k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var hs-var">(=:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#singleton"><span class="hs-identifier hs-var">M.singleton</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span id="local-6989586621679400342"><span class="annot"><span class="annottext">subnet_tree :: (CanisterId, b, c, d, [(Word64, Word64)]) -&gt; Map Blob LabeledTree
</span><a href="#local-6989586621679400342"><span class="hs-identifier hs-var hs-var">subnet_tree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679400297"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400297"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400296"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400296"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400297"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;public_key&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400297"><span class="hs-identifier hs-var">subnet_id</span></a></span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister_ranges&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400344"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CanisterRange] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodeCanisterRangeList"><span class="hs-identifier hs-var">encodeCanisterRangeList</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679400294"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400294"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400293"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400293"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400294"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400293"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400296"><span class="hs-identifier hs-var">ranges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-333"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="annot"><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-type">delegationTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#SubnetId"><span class="hs-identifier hs-type">SubnetId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span><span>
</span><span id="line-336"></span><span id="delegationTree"><span class="annot"><span class="annottext">delegationTree :: Timestamp
-&gt; CanisterId -&gt; Blob -&gt; [(Word64, Word64)] -&gt; LabeledTree
</span><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-var hs-var">delegationTree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679400289"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679400289"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679400288"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400288"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679400287"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400287"><span class="hs-identifier hs-var">subnet_pub_key</span></a></span></span><span> </span><span id="local-6989586621679400286"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400286"><span class="hs-identifier hs-var">ranges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400285"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400284"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400283"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679400289"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;subnet&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400284"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400285"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400288"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400284"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400285"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-340"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;public_key&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400284"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400283"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400287"><span class="hs-identifier hs-var">subnet_pub_key</span></a></span><span>
</span><span id="line-341"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister_ranges&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400284"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400283"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CanisterRange] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodeCanisterRangeList"><span class="hs-identifier hs-var">encodeCanisterRangeList</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679400282"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400282"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400281"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400281"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400282"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679400281"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400286"><span class="hs-identifier hs-var">ranges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-347"></span><span>    </span><span id="local-6989586621679400285"><span class="annot"><span class="annottext">node :: [Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679400285"><span class="hs-identifier hs-var hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Blob LabeledTree -&gt; LabeledTree
</span><a href="IC.HashTree.html#SubTrees"><span class="hs-identifier hs-var">SubTrees</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621679400278"><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400278"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400278"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span></span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621679400283"><span class="annot"><span class="annottext">val :: forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679400283"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
</span><a href="IC.HashTree.html#Value"><span class="hs-identifier hs-var">Value</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; Blob
</span><a href="IC.Certificate.Value.html#toCertVal"><span class="hs-identifier hs-var">toCertVal</span></a></span><span>
</span><span id="line-350"></span><span>    </span><span id="local-6989586621679400284"><span class="annot"><span class="annottext">=: :: k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679400284"><span class="hs-operator hs-var hs-var">(=:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#singleton"><span class="hs-identifier hs-var">M.singleton</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span id="local-6989586621679401400"><span class="annot"><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-type">getPrunedCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401400"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401400"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.HashTree.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401400"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span></span><span>
</span><span id="line-353"></span><span id="getPrunedCertificate"><span class="annot"><span class="annottext">getPrunedCertificate :: forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var hs-var">getPrunedCertificate</span></a></span></span><span> </span><span id="local-6989586621679400253"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400253"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679400252"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400252"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679400251"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400251"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621679400250"><span class="annot"><span class="annottext">Maybe CanisterId
</span><a href="#local-6989586621679400250"><span class="hs-identifier hs-var">root_subnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Maybe CanisterId
</span><a href="IC.Ref.Types.html#rootSubnet"><span class="hs-identifier hs-var">rootSubnet</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span id="local-6989586621679400248"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400248"><span class="hs-identifier hs-var">sk1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; SecretKey
</span><a href="IC.Ref.Types.html#secretRootKey"><span class="hs-identifier hs-var">secretRootKey</span></a></span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679400246"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400246"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubnetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400245"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400245"><span class="hs-identifier hs-var">sk2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400244"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400244"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
CanisterId -&gt; m Subnet
</span><a href="IC.Ref.Types.html#getSubnetFromCanisterId"><span class="hs-identifier hs-var">getSubnetFromCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400252"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-357"></span><span>    </span><span id="local-6989586621679400242"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400242"><span class="hs-identifier hs-var">full_tree</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabeledTree -&gt; HashTree
</span><a href="IC.HashTree.html#construct"><span class="hs-identifier hs-var">construct</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; IC -&gt; LabeledTree
</span><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-var">stateTree</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400253"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400240"><span class="annot"><span class="annottext">cert_tree :: HashTree
</span><a href="#local-6989586621679400240"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; [Path] -&gt; HashTree
</span><a href="IC.HashTree.html#prune"><span class="hs-identifier hs-var">prune</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400242"><span class="hs-identifier hs-var">full_tree</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679400251"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
-&gt; SecretKey
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400253"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400248"><span class="hs-identifier hs-var">sk1</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Maybe CanisterId
</span><a href="#local-6989586621679400250"><span class="hs-identifier hs-var">root_subnet</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400246"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400246"><span class="hs-identifier hs-var">subnet_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400245"><span class="hs-identifier hs-var">sk2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400244"><span class="hs-identifier hs-var">ranges</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400240"><span class="hs-identifier hs-var">cert_tree</span></a></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="annot"><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-type">signCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#SubnetId"><span class="hs-identifier hs-type">SubnetId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#HashTree"><span class="hs-identifier hs-type">HashTree</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span>
</span><span id="line-362"></span><span id="signCertificate"><span class="annot"><span class="annottext">signCertificate :: Timestamp
-&gt; SecretKey
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var hs-var">signCertificate</span></a></span></span><span> </span><span id="local-6989586621679400237"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400237"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679400236"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400236"><span class="hs-identifier hs-var">rootKey</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400235"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400235"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400234"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400234"><span class="hs-identifier hs-var">subnet_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400233"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400233"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679400232"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400232"><span class="hs-identifier hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashTree
cert_tree :: HashTree
cert_tree :: HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
cert_sig :: Blob
cert_sig :: Blob
</span><a href="IC.Certificate.html#cert_sig"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Delegation
cert_delegation :: Maybe Delegation
cert_delegation :: Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-364"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621679400229"><span class="annot"><span class="annottext">cert_sig :: Blob
</span><a href="#local-6989586621679400229"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; Blob
</span><a href="IC.Crypto.html#signPure"><span class="hs-identifier hs-var">signPure</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400234"><span class="hs-identifier hs-var">subnet_key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400232"><span class="hs-identifier hs-var">cert_tree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>    </span><span id="local-6989586621679400227"><span class="annot"><span class="annottext">cert_delegation :: Maybe Delegation
</span><a href="#local-6989586621679400227"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Certificate.html#Delegation"><span class="hs-identifier hs-type">Delegation</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Blob
del_subnet_id :: Blob
del_subnet_id :: Blob
</span><a href="IC.Certificate.html#del_subnet_id"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
del_certificate :: Blob
del_certificate :: Blob
</span><a href="IC.Certificate.html#del_certificate"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621679400222"><span class="annot"><span class="annottext">del_subnet_id :: Blob
</span><a href="#local-6989586621679400222"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Blob
</span><a href="IC.Types.html#rawEntityId"><span class="hs-identifier hs-var">rawEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400235"><span class="hs-identifier hs-var">subnet_id</span></a></span><span>
</span><span id="line-368"></span><span>    </span><span id="local-6989586621679400220"><span class="annot"><span class="annottext">del_certificate :: Blob
</span><a href="#local-6989586621679400220"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-369"></span><span>      </span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.CBOR.html#encodeCert"><span class="hs-identifier hs-var">encodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><span class="annottext">Timestamp
-&gt; SecretKey
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400237"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400236"><span class="hs-identifier hs-var">rootKey</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="annot"><span class="annottext">LabeledTree -&gt; HashTree
</span><a href="IC.HashTree.html#construct"><span class="hs-identifier hs-var">construct</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><span class="annottext">Timestamp
-&gt; CanisterId -&gt; Blob -&gt; [(Word64, Word64)] -&gt; LabeledTree
</span><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-var">delegationTree</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400237"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400235"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400234"><span class="hs-identifier hs-var">subnet_key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679400233"><span class="hs-identifier hs-var">ranges</span></a></span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span class="annot"><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span id="local-6989586621679400215"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400215"><span class="hs-identifier hs-var">_time</span></a></span></span><span> </span><span id="local-6989586621679400214"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400214"><span class="hs-identifier hs-var">rootKey</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (CanisterId, SecretKey, [(Word64, Word64)])
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span id="local-6989586621679400213"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400213"><span class="hs-identifier hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashTree
cert_tree :: HashTree
cert_tree :: HashTree
</span><a href="#local-6989586621679400213"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
cert_sig :: Blob
cert_sig :: Blob
</span><a href="#local-6989586621679400212"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cert_delegation :: Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var">cert_delegation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-376"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-377"></span><span>    </span><span id="local-6989586621679400212"><span class="annot"><span class="annottext">cert_sig :: Blob
</span><a href="#local-6989586621679400212"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; Blob
</span><a href="IC.Crypto.html#signPure"><span class="hs-identifier hs-var">signPure</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679400214"><span class="hs-identifier hs-var">rootKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679400213"><span class="hs-identifier hs-var">cert_tree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="hs-comment">-- If `stateTree` ever becomes a bottleneck:</span><span>
</span><span id="line-380"></span><span class="hs-comment">-- Since ic-ref creates a fresh state tree everytime it is used, we _could_</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- construct one with just the required data, e.g. only of the canister in</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- question. That would not be secure, but `ic-ref` doesn&#8217;t have to be.</span><span>
</span><span id="line-383"></span><span id="local-6989586621679401414"><span class="annot"><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-type">getDataCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401414"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401414"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401414"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span></span><span>
</span><span id="line-384"></span><span id="getDataCertificate"><span class="annot"><span class="annottext">getDataCertificate :: forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; m Blob
</span><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-var hs-var">getDataCertificate</span></a></span></span><span> </span><span id="local-6989586621679400194"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400194"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679400193"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400193"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.CBOR.html#encodeCert"><span class="hs-identifier hs-var">encodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var">getPrunedCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679400194"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400193"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Blob
</span><a href="IC.Types.html#rawEntityId"><span class="hs-identifier hs-var">rawEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400193"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;certified_data&quot;</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="hs-comment">-- Asynchronous requests</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="hs-comment">-- | Submission simply enqueues requests</span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span id="local-6989586621679401317"><span class="annot"><a href="IC.Ref.html#submitRequest"><span class="hs-identifier hs-type">submitRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401317"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401317"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-393"></span><span id="submitRequest"><span class="annot"><span class="annottext">submitRequest :: forall (m :: * -&gt; *).
ICM m =&gt;
Blob -&gt; CallRequest -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#submitRequest"><span class="hs-identifier hs-var hs-var">submitRequest</span></a></span></span><span> </span><span id="local-6989586621679400186"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400186"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679400185"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679400185"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679400184"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400184"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400183"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400183"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">M.member</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400186"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400183"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400183"><span class="hs-identifier hs-var">ic</span></a></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400183"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">requests :: Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">M.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400186"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679400185"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400184"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400183"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="hs-comment">-- | Eventually, they are processed</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="local-6989586621679401311"><span class="annot"><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-type">processRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401311"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401311"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-402"></span><span id="processRequest"><span class="annot"><span class="annottext">processRequest :: forall (m :: * -&gt; *).
ICM m =&gt;
(Blob, CallRequest, CanisterId) -&gt; m ()
</span><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-var hs-var">processRequest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400168"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400168"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679400167"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400167"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679400166"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400166"><span class="hs-identifier hs-var">_user_id</span></a></span></span><span> </span><span id="local-6989586621679400165"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400165"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679400164"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400164"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400163"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400163"><span class="hs-identifier hs-var">ecid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400168"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; RequestStatus
</span><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; CallResponse
</span><a href="IC.Ref.Types.html#canisterRejected"><span class="hs-identifier hs-var">canisterRejected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621679400142"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400142"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400167"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CanisterId -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#FromUser"><span class="hs-identifier hs-var">FromUser</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400168"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679400163"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-409"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-410"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-411"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.Types.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-413"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400142"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Blob -&gt; EntryPoint
</span><a href="IC.Ref.Types.html#Public"><span class="hs-identifier hs-var">Public</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400165"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400164"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679400168"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span class="hs-comment">-- Call context handling</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span id="local-6989586621679401308"><span class="annot"><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-type">newCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401308"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401308"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span></span><span>
</span><span id="line-421"></span><span id="newCallContext"><span class="annot"><span class="annottext">newCallContext :: forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var hs-var">newCallContext</span></a></span></span><span> </span><span id="local-6989586621679400122"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679400122"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400120"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400119"><span class="annot"><span class="annottext">i :: CallId
</span><a href="#local-6989586621679400119"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Map CallId a -&gt; CallId
</span><a href="IC.Utils.html#freshKey"><span class="hs-identifier hs-var">freshKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400119"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_contexts :: CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">M.insert</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400119"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679400122"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span id="local-6989586621679401298"><span class="annot"><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-type">rememberTrap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401298"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401298"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-426"></span><span id="rememberTrap"><span class="annot"><span class="annottext">rememberTrap :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; String -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var hs-var">rememberTrap</span></a></span></span><span> </span><span id="local-6989586621679400107"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400107"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679400106"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400106"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.Types.html#modifyCallContext"><span class="hs-identifier hs-var">modifyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400107"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400104"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679400104"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679400104"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400106"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span id="local-6989586621679401295"><span class="annot"><a href="IC.Ref.html#needsToRespondCallID"><span class="hs-identifier hs-type">needsToRespondCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span></span><span>
</span><span id="line-430"></span><span id="needsToRespondCallID"><span class="annot"><span class="annottext">needsToRespondCallID :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m NeedsToRespond
</span><a href="IC.Ref.html#needsToRespondCallID"><span class="hs-identifier hs-var hs-var">needsToRespondCallID</span></a></span></span><span> </span><span id="local-6989586621679400090"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400090"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400090"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span id="local-6989586621679401292"><span class="annot"><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-type">deletedCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401292"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401292"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-433"></span><span id="deletedCallID"><span class="annot"><span class="annottext">deletedCallID :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Bool
</span><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-var hs-var">deletedCallID</span></a></span></span><span> </span><span id="local-6989586621679400075"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400075"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400075"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span id="local-6989586621679401290"><span class="annot"><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-type">starveCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-436"></span><span id="starveCallContext"><span class="annot"><span class="annottext">starveCallContext :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m ()
</span><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-var hs-var">starveCallContext</span></a></span></span><span> </span><span id="local-6989586621679400058"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400058"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>  </span><span id="local-6989586621679400057"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679400057"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400058"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-438"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679400056"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400056"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400055"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679400055"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679400054"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400054"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Maybe String
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679400057"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400054"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_TRAPPED"><span class="hs-identifier hs-var">EC_CANISTER_TRAPPED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister did not respond&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_DID_NOT_REPLY"><span class="hs-identifier hs-var">EC_CANISTER_DID_NOT_REPLY</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; (RejectCode, String, Maybe ErrorCode) -&gt; m ()
</span><a href="IC.Ref.Types.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400058"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679400056"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679400055"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span id="local-6989586621679400051"><span class="annot"><a href="IC.Ref.html#removeCallContext"><span class="hs-identifier hs-type">removeCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-443"></span><span id="removeCallContext"><span class="annot"><span class="annottext">removeCallContext :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m ()
</span><a href="IC.Ref.html#removeCallContext"><span class="hs-identifier hs-var hs-var">removeCallContext</span></a></span></span><span> </span><span id="local-6989586621679400045"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400045"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-444"></span><span>  </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400044"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400044"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400044"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_contexts :: CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#delete"><span class="hs-identifier hs-var">M.delete</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679400045"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679400044"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="hs-comment">-- Message handling</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span id="local-6989586621679400042"><span class="annot"><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-type">processMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-449"></span><span id="processMessage"><span class="annot"><span class="annottext">processMessage :: forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var hs-var">processMessage</span></a></span></span><span> </span><span id="local-6989586621679399993"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679399993"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679399993"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span> </span><span id="local-6989586621679399992"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399991"><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399991"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, String, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; (RejectCode, String, Maybe ErrorCode) -&gt; m ()
</span><a href="IC.Ref.Types.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-451"></span><span>    </span><span id="local-6989586621679399901"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-452"></span><span>    </span><span id="local-6989586621679399899"><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679399899"><span class="hs-identifier hs-var">maybeSubnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
CanisterId -&gt; m (Maybe Subnet)
</span><a href="IC.Ref.Types.html#getSubnetFromSubnetId"><span class="hs-identifier hs-var">getSubnetFromSubnetId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679399899"><span class="hs-identifier hs-var">maybeSubnet</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>      </span><span id="local-6989586621679399895"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399895"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#callerOfCallID"><span class="hs-identifier hs-var">callerOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(CanReject m, ICM m, MonadIO m) =&gt;
CanisterId -&gt; Maybe Subnet -&gt; CallId -&gt; EntryPoint -&gt; m ()
</span><a href="IC.Ref.Management.html#invokeManagementCanister"><span class="hs-identifier hs-var">invokeManagementCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399895"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Subnet
</span><a href="#local-6989586621679399899"><span class="hs-identifier hs-var">maybeSubnet</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399991"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-458"></span><span>      </span><span id="local-6989586621679399892"><span class="annot"><span class="annottext">RunStatus
</span><a href="#local-6989586621679399892"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m RunStatus
</span><a href="IC.Ref.Types.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-459"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunStatus
</span><a href="#local-6989586621679399892"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399991"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-460"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>          </span><span class="hs-comment">-- This is a hack, detecting callbacks via the entry, and demands refactoring</span><span>
</span><span id="line-463"></span><span>          </span><span class="annot"><span class="annottext">(RunStatus, EntryPoint)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister is not running&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_NOT_RUNNING"><span class="hs-identifier hs-var">EC_CANISTER_NOT_RUNNING</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>      </span><span id="local-6989586621679399888"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399888"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399888"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; String -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;canister is empty&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_EMPTY"><span class="hs-identifier hs-var">EC_CANISTER_EMPTY</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NB: An empty canister cannot receive a callback.</span><span>
</span><span id="line-466"></span><span>      </span><span id="local-6989586621679399887"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399887"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m WasmState
</span><a href="IC.Ref.Types.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-467"></span><span>      </span><span id="local-6989586621679399886"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399886"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-468"></span><span>      </span><span id="local-6989586621679399885"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399885"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Env
</span><a href="IC.Ref.Types.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-469"></span><span>      </span><span id="local-6989586621679399884"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399884"><span class="hs-identifier hs-var">sender_canister_version_from_system</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCanisterVersion"><span class="hs-identifier hs-var">getCanisterVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-470"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId
-&gt; CanisterId
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m (TrapOr (WasmState, UpdateResult))
</span><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-var">invokeEntry</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399887"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399886"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399885"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399991"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679399881"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399881"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>          </span><span class="hs-comment">-- Eventually update cycle balance here</span><span>
</span><span id="line-473"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; String -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var">rememberTrap</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399881"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399880"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399880"><span class="hs-identifier hs-var">new_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399879"><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399879"><span class="hs-identifier hs-var">call_actions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399878"><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679399878"><span class="hs-identifier hs-var">canister_actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-475"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CanisterId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.Types.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399876"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399876"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399876"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">last_action :: Maybe EntryPoint
</span><a href="IC.Ref.Types.html#last_action"><span class="hs-identifier hs-var">last_action</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399991"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-476"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; CallActions -&gt; Word64 -&gt; m ()
</span><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-var">performCallActions</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399992"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399879"><span class="hs-identifier hs-var">call_actions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399884"><span class="hs-identifier hs-var">sender_canister_version_from_system</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CanisterId -&gt; CanisterActions -&gt; m ()
</span><a href="IC.Ref.Types.html#performCanisterActions"><span class="hs-identifier hs-var">performCanisterActions</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679399878"><span class="hs-identifier hs-var">canister_actions</span></a></span><span>
</span><span id="line-478"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; WasmState -&gt; m ()
</span><a href="IC.Ref.Types.html#setCanisterState"><span class="hs-identifier hs-var">setCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399901"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399880"><span class="hs-identifier hs-var">new_state</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><a href="IC.Ref.Types.html#ResponseMessage"><span class="hs-identifier hs-type">ResponseMessage</span></a></span><span> </span><span id="local-6989586621679399870"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399870"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399869"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679399869"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span id="local-6989586621679399868"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399868"><span class="hs-identifier hs-var">refunded_cycles</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-481"></span><span>    </span><span id="local-6989586621679399867"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679399867"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399870"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679399867"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-483"></span><span>      </span><span class="annot"><span class="annottext">CallOrigin
</span><a href="IC.Ref.Types.html#FromSystemTask"><span class="hs-identifier hs-var">FromSystemTask</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Response from system task&quot;</span></span><span>
</span><span id="line-484"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#FromUser"><span class="hs-identifier hs-type">FromUser</span></a></span><span> </span><span id="local-6989586621679399864"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399864"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399864"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; RequestStatus
</span><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-486"></span><span>          </span><span class="hs-comment">-- NB: Here cycles disappear</span><span>
</span><span id="line-487"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679399869"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-488"></span><span>            </span><span class="annot"><a href="IC.Types.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399863"><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679399863"><span class="hs-identifier hs-var">rc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399862"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399862"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RejectCode, String, Maybe ErrorCode) -&gt; CallResponse
</span><a href="IC.Ref.Types.html#canisterRejected"><span class="hs-identifier hs-var">canisterRejected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679399863"><span class="hs-identifier hs-var">rc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399862"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>            </span><span class="annot"><a href="IC.Types.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679399861"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399861"><span class="hs-identifier hs-var">blob</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallResponse
</span><a href="IC.Ref.Types.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399861"><span class="hs-identifier hs-var">blob</span></a></span><span>
</span><span id="line-490"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier hs-var">processSystemTasks</span></a></span><span>
</span><span id="line-491"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679399859"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399859"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399858"><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679399858"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-comment">-- Add refund to balance</span><span>
</span><span id="line-493"></span><span>        </span><span id="local-6989586621679399857"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399857"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399859"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-494"></span><span>        </span><span id="local-6989586621679399856"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399856"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399857"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399857"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399856"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399868"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span>
</span><span id="line-496"></span><span>        </span><span class="hs-comment">-- Unless deleted</span><span>
</span><span id="line-497"></span><span>        </span><span id="local-6989586621679399852"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399852"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Bool
</span><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-var">deletedCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399859"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-498"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399852"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-499"></span><span>          </span><span class="hs-comment">-- Enqueue execution</span><span>
</span><span id="line-500"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.Types.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-501"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399859"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-502"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Callback -&gt; Response -&gt; Natural -&gt; EntryPoint
</span><a href="IC.Ref.Types.html#Closure"><span class="hs-identifier hs-var">Closure</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679399858"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679399869"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399868"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span>
</span><span id="line-503"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span id="local-6989586621679401273"><span class="annot"><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-type">performCallActions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401273"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CallActions"><span class="hs-identifier hs-type">CallActions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401273"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-506"></span><span id="performCallActions"><span class="annot"><span class="annottext">performCallActions :: forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; CallActions -&gt; Word64 -&gt; m ()
</span><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-var hs-var">performCallActions</span></a></span></span><span> </span><span id="local-6989586621679399829"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399829"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399828"><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399828"><span class="hs-identifier hs-var">ca</span></a></span></span><span> </span><span id="local-6989586621679399827"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399827"><span class="hs-identifier hs-var">sender_canister_version_from_system</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; [MethodCall] -&gt; Natural -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-var">updateBalances</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399829"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var">ca_new_calls</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399828"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Natural
</span><a href="IC.Types.html#ca_accept"><span class="hs-identifier hs-var">ca_accept</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399828"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Natural
</span><a href="IC.Types.html#ca_mint"><span class="hs-identifier hs-var">ca_mint</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399828"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; Word64 -&gt; MethodCall -&gt; m ()
</span><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-var">newCall</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399829"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399827"><span class="hs-identifier hs-var">sender_canister_version_from_system</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var">ca_new_calls</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399828"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Response -&gt; m ()
</span><a href="IC.Ref.Types.html#respondCallContext"><span class="hs-identifier hs-var">respondCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399829"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Maybe Response
</span><a href="IC.Types.html#ca_response"><span class="hs-identifier hs-var">ca_response</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679399828"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span id="local-6989586621679401261"><span class="annot"><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-type">updateBalances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401261"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401261"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-513"></span><span id="updateBalances"><span class="annot"><span class="annottext">updateBalances :: forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; [MethodCall] -&gt; Natural -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-var hs-var">updateBalances</span></a></span></span><span> </span><span id="local-6989586621679399775"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399775"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399774"><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679399774"><span class="hs-identifier hs-var">new_calls</span></a></span></span><span> </span><span id="local-6989586621679399773"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399773"><span class="hs-identifier hs-var">accepted</span></a></span></span><span> </span><span id="local-6989586621679399772"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399772"><span class="hs-identifier hs-var">minted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-514"></span><span>  </span><span id="local-6989586621679399771"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399771"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399775"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-comment">-- Eventually update when we track cycle consumption</span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399769"><span class="annot"><span class="annottext">max_cycles :: Natural
</span><a href="#local-6989586621679399769"><span class="hs-identifier hs-var hs-var">max_cycles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399767"><span class="annot"><span class="annottext">cycles_consumed :: Natural
</span><a href="#local-6989586621679399767"><span class="hs-identifier hs-var hs-var">cycles_consumed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-519"></span><span>
</span><span id="line-520"></span><span>  </span><span id="local-6989586621679399766"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399766"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399771"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-521"></span><span>  </span><span id="local-6989586621679399765"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399765"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399775"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399773"><span class="hs-identifier hs-var">accepted</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399765"><span class="hs-identifier hs-var">available</span></a></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399763"><span class="annot"><span class="annottext">to_spend :: Natural
</span><a href="#local-6989586621679399763"><span class="hs-identifier hs-var hs-var">to_spend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399766"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399773"><span class="hs-identifier hs-var">accepted</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399772"><span class="hs-identifier hs-var">minted</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399769"><span class="hs-identifier hs-var">max_cycles</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399762"><span class="annot"><span class="annottext">transferred :: Natural
</span><a href="#local-6989586621679399762"><span class="hs-identifier hs-var hs-var">transferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#sum"><span class="hs-identifier hs-var">sum</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; Natural
</span><a href="IC.Types.html#call_transferred_cycles"><span class="hs-identifier hs-var">call_transferred_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399759"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679399759"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399759"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679399774"><span class="hs-identifier hs-var">new_calls</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399762"><span class="hs-identifier hs-var">transferred</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399763"><span class="hs-identifier hs-var">to_spend</span></a></span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-528"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399771"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399766"><span class="hs-identifier hs-var">prev_balance</span></a></span><span>
</span><span id="line-529"></span><span>        </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399773"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-530"></span><span>        </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399772"><span class="hs-identifier hs-var">minted</span></a></span><span>
</span><span id="line-531"></span><span>        </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399767"><span class="hs-identifier hs-var">cycles_consumed</span></a></span><span>
</span><span id="line-532"></span><span>        </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399762"><span class="hs-identifier hs-var">transferred</span></a></span><span>
</span><span id="line-533"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setCallContextCycles"><span class="hs-identifier hs-var">setCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399775"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399765"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399773"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Internal error: More cycles transferred than available&quot;</span></span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Internal error: More cycles accepted than available&quot;</span></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span id="local-6989586621679401249"><span class="annot"><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-type">actuallyStopCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401249"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401249"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-539"></span><span id="actuallyStopCanister"><span class="annot"><span class="annottext">actuallyStopCanister :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-var hs-var">actuallyStopCanister</span></a></span></span><span> </span><span id="local-6989586621679399722"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399722"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-540"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m RunStatus
</span><a href="IC.Ref.Types.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399722"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-541"></span><span>        </span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679399721"><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679399721"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-542"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.Types.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399722"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsStopped"><span class="hs-identifier hs-var">IsStopped</span></a></span><span>
</span><span id="line-543"></span><span>            </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679399721"><span class="hs-identifier hs-var">pending</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399718"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399718"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-544"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.Types.html#replyCallContext"><span class="hs-identifier hs-var">replyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399718"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. CandidArg a =&gt; a -&gt; Blob
</span><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#encode"><span class="hs-identifier hs-var">Codec.Candid.encode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>        </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected canister status&quot;</span></span><span>
</span><span id="line-546"></span><span>        </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsStopped"><span class="hs-identifier hs-var">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected canister status&quot;</span></span><span>
</span><span id="line-547"></span><span>        </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span> </span><span>
</span><span id="line-550"></span><span id="local-6989586621679401278"><span class="annot"><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-type">invokeEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-551"></span><span>    </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#CanisterModule"><span class="hs-identifier hs-type">CanisterModule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-552"></span><span>    </span><span class="annot"><a href="#local-6989586621679401278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#TrapOr"><span class="hs-identifier hs-type">TrapOr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#UpdateResult"><span class="hs-identifier hs-type">UpdateResult</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-553"></span><span id="invokeEntry"><span class="annot"><span class="annottext">invokeEntry :: forall (m :: * -&gt; *).
ICM m =&gt;
CallId
-&gt; CanisterId
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m (TrapOr (WasmState, UpdateResult))
</span><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-var hs-var">invokeEntry</span></a></span></span><span> </span><span id="local-6989586621679399657"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399657"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399656"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399656"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679399655"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span id="local-6989586621679399654"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span id="local-6989586621679399653"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399653"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679399652"><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399652"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-554"></span><span>    </span><span id="local-6989586621679399651"><span class="annot"><span class="annottext">NeedsToRespond
</span><a href="#local-6989586621679399651"><span class="hs-identifier hs-var">needs_to_respond</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m NeedsToRespond
</span><a href="IC.Ref.html#needsToRespondCallID"><span class="hs-identifier hs-var">needsToRespondCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399657"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-555"></span><span>    </span><span id="local-6989586621679399650"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399650"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399657"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679399652"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-557"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#Public"><span class="hs-identifier hs-type">Public</span></a></span><span> </span><span id="local-6989586621679399649"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399649"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679399648"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399648"><span class="hs-identifier hs-var">dat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-558"></span><span>        </span><span id="local-6989586621679399647"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399647"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#callerOfCallID"><span class="hs-identifier hs-var">callerOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399657"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-559"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String
-&gt; CanisterModule
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc,
      Bool)
</span><a href="#local-6989586621679399646"><span class="hs-identifier hs-var">lookupUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399649"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-560"></span><span>          </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399645"><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679399645"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399644"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399644"><span class="hs-identifier hs-var">bump</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-561"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679399645"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399647"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399653"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsToRespond
</span><a href="#local-6989586621679399651"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399650"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399648"><span class="hs-identifier hs-var">dat</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-562"></span><span>              </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679399643"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399643"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. String -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399643"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-563"></span><span>              </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span id="local-6989586621679399642"><span class="annot"><span class="annottext">(WasmState, UpdateResult)
</span><a href="#local-6989586621679399642"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>                </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399644"><span class="hs-identifier hs-var">bump</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#bumpCanisterVersion"><span class="hs-identifier hs-var">bumpCanisterVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399656"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-565"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult)
</span><a href="#local-6989586621679399642"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-566"></span><span>          </span><span class="annot"><span class="annottext">Maybe
  (CanisterId
   -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc,
   Bool)
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-567"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399640"><span class="annot"><span class="annottext">reject :: Response
</span><a href="#local-6989586621679399640"><span class="hs-identifier hs-var hs-var">reject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; Response
</span><a href="IC.Types.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;method does not exist: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399649"><span class="hs-identifier hs-var">method</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_response :: Maybe Response
</span><a href="IC.Types.html#ca_response"><span class="hs-identifier hs-var">ca_response</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679399640"><span class="hs-identifier hs-var">reject</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span> </span><span id="local-6989586621679399637"><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679399637"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span id="local-6989586621679399636"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679399636"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679399635"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399635"><span class="hs-identifier hs-var">refund</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-570"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Callback
-&gt; Env
-&gt; NeedsToRespond
-&gt; Natural
-&gt; Response
-&gt; Natural
-&gt; UpdateFunc
</span><a href="IC.Canister.html#callbacks"><span class="hs-identifier hs-var">callbacks</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679399637"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399653"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsToRespond
</span><a href="#local-6989586621679399651"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399650"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679399636"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399635"><span class="hs-identifier hs-var">refund</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-571"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679399633"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399633"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-572"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; String -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var">rememberTrap</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399657"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399633"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-573"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Callback -&gt; Maybe WasmClosure
</span><a href="IC.Types.html#cleanup_callback"><span class="hs-identifier hs-var">cleanup_callback</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679399637"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-574"></span><span>                  </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679399631"><span class="annot"><span class="annottext">WasmClosure
</span><a href="#local-6989586621679399631"><span class="hs-identifier hs-var">closure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; WasmClosure -&gt; Env -&gt; WasmState -&gt; TrapOr (WasmState, ())
</span><a href="IC.Canister.html#cleanup"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">WasmClosure
</span><a href="#local-6989586621679399631"><span class="hs-identifier hs-var">closure</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399653"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-575"></span><span>                      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679399629"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">err'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. String -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">err'</span></a></span><span>
</span><span id="line-576"></span><span>                      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399628"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399628"><span class="hs-identifier hs-var">wasm_state'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>                          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#bumpCanisterVersion"><span class="hs-identifier hs-var">bumpCanisterVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399656"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-578"></span><span>                          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399628"><span class="hs-identifier hs-var">wasm_state'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>                  </span><span class="annot"><span class="annottext">Maybe WasmClosure
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. String -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399633"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-580"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399627"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399627"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399626"><span class="annot"><span class="annottext">UpdateResult
</span><a href="#local-6989586621679399626"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#bumpCanisterVersion"><span class="hs-identifier hs-var">bumpCanisterVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399656"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-582"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399627"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UpdateResult
</span><a href="#local-6989586621679399626"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>      </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#Heartbeat"><span class="hs-identifier hs-var">Heartbeat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-584"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CanisterModule -&gt; Bool
</span><a href="IC.Canister.html#exports_heartbeat"><span class="hs-identifier hs-var">exports_heartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-585"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Env
-&gt; WasmState
-&gt; TrapOr (WasmState, ([MethodCall], CanisterActions))
</span><a href="IC.Canister.html#heartbeat"><span class="hs-identifier hs-var">heartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399653"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-586"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399622"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399622"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399621"><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679399621"><span class="hs-identifier hs-var">calls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399620"><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679399620"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-588"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#bumpCanisterVersion"><span class="hs-identifier hs-var">bumpCanisterVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399656"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-589"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399622"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_new_calls :: [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var">ca_new_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679399621"><span class="hs-identifier hs-var">calls</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679399620"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span>      </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#GlobalTimer"><span class="hs-identifier hs-var">GlobalTimer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-592"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CanisterModule -&gt; Bool
</span><a href="IC.Canister.html#exports_global_timer"><span class="hs-identifier hs-var">exports_global_timer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Env
-&gt; WasmState
-&gt; TrapOr (WasmState, ([MethodCall], CanisterActions))
</span><a href="IC.Canister.html#canister_global_timer"><span class="hs-identifier hs-var">canister_global_timer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399654"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679399653"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-594"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399616"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399616"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399615"><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679399615"><span class="hs-identifier hs-var">calls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399614"><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679399614"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-596"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#bumpCanisterVersion"><span class="hs-identifier hs-var">bumpCanisterVersion</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399656"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-597"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399616"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_new_calls :: [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var">ca_new_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679399615"><span class="hs-identifier hs-var">calls</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679399614"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679399655"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-600"></span><span>    </span><span id="local-6989586621679399646"><span class="annot"><span class="annottext">lookupUpdate :: String
-&gt; CanisterModule
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc,
      Bool)
</span><a href="#local-6989586621679399646"><span class="hs-identifier hs-var hs-var">lookupUpdate</span></a></span></span><span> </span><span id="local-6989586621679399610"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399610"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679399609"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399609"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span>
</span><span id="line-601"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679399608"><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679399608"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399610"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; String
   &#8614; (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="IC.Canister.html#update_methods"><span class="hs-identifier hs-var">update_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399609"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679399608"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679399606"><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679399606"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679399610"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; String &#8614; (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
</span><a href="IC.Canister.html#query_methods"><span class="hs-identifier hs-var">query_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679399609"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; CanisterId
-&gt; Env
-&gt; NeedsToRespond
-&gt; Natural
-&gt; Blob
-&gt; UpdateFunc
</span><a href="IC.Canister.html#asUpdate"><span class="hs-identifier hs-var">asUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679399606"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-604"></span><span>
</span><span id="line-605"></span><span class="annot"><a href="IC.Ref.html#fetchSenderCanisterVersion"><span class="hs-identifier hs-type">fetchSenderCanisterVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401239"><span class="annot"><a href="#local-6989586621679401239"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401239"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="IC.Management.html#SenderCanisterVersion"><span class="hs-identifier hs-type">SenderCanisterVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-607"></span><span>  </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span>
</span><span id="line-608"></span><span id="fetchSenderCanisterVersion"><span class="annot"><span class="annottext">fetchSenderCanisterVersion :: forall a. (a ~ SenderCanisterVersion) =&gt; Blob -&gt; Maybe Word64
</span><a href="IC.Ref.html#fetchSenderCanisterVersion"><span class="hs-identifier hs-var hs-var">fetchSenderCanisterVersion</span></a></span></span><span> </span><span id="local-6989586621679399547"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399547"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. CandidArg a =&gt; Blob -&gt; Either String a
</span><a href="file:///nix/store/jkxjsrg5143afynhvaz1h65p40k9xpg6-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#decode"><span class="hs-identifier hs-var">decode</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679401239"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399547"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-609"></span><span>                                                   </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679399546"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399546"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399546"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><a href="file:///nix/store/nnzz8gzyw0qnn3bhw2mz58w4is6jbk20-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator hs-var">.!</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. IsLabel &quot;sender_canister_version&quot; a =&gt; a
</span><span class="">#sender_canister_version</span></span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span class="annot"><a href="IC.Ref.html#validate_call"><span class="hs-identifier hs-type">validate_call</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RejectCode"><span class="hs-identifier hs-type">RejectCode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span id="validate_call"><span class="annot"><span class="annottext">validate_call :: MethodCall
-&gt; [CanisterId] -&gt; Bool -&gt; Word64 -&gt; Either (RejectCode, String) ()
</span><a href="IC.Ref.html#validate_call"><span class="hs-identifier hs-var hs-var">validate_call</span></a></span></span><span> </span><span id="local-6989586621679399544"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399544"><span class="hs-identifier hs-var">call</span></a></span></span><span> </span><span id="local-6989586621679399543"><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399543"><span class="hs-identifier hs-var">subs</span></a></span></span><span> </span><span id="local-6989586621679399542"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399542"><span class="hs-identifier hs-var">isOnRootSubnet</span></a></span></span><span> </span><span id="local-6989586621679399541"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399541"><span class="hs-identifier hs-var">sender_canister_version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><span class="annottext">MethodCall -&gt; Either (RejectCode, String) ()
</span><a href="#local-6989586621679399540"><span class="hs-identifier hs-var">validate_subnet_message</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399544"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-614"></span><span>  </span><span class="annot"><span class="annottext">MethodCall -&gt; Either (RejectCode, String) ()
</span><a href="#local-6989586621679399539"><span class="hs-identifier hs-var">validate_sender_canister_version</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399544"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-615"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-616"></span><span>    </span><span id="local-6989586621679399540"><span class="annot"><span class="annottext">validate_subnet_message :: MethodCall -&gt; Either (RejectCode, String) ()
</span><a href="#local-6989586621679399540"><span class="hs-identifier hs-var hs-var">validate_subnet_message</span></a></span></span><span> </span><span id="local-6989586621679399538"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399538"><span class="hs-identifier hs-var">call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-617"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; CanisterId
</span><a href="IC.Types.html#call_callee"><span class="hs-identifier hs-var">call_callee</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399538"><span class="hs-identifier hs-var">call</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399543"><span class="hs-identifier hs-var">subs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399542"><span class="hs-identifier hs-var">isOnRootSubnet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-618"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Only NNS canisters can call a subnet ID directly.&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>    </span><span id="local-6989586621679399530"><span class="annot"><span class="annottext">sender_canister_version_methods :: [String]
</span><a href="#local-6989586621679399530"><span class="hs-identifier hs-var hs-var">sender_canister_version_methods</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;create_canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;update_settings&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;install_code&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;uninstall_code&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-620"></span><span>    </span><span id="local-6989586621679399539"><span class="annot"><span class="annottext">validate_sender_canister_version :: MethodCall -&gt; Either (RejectCode, String) ()
</span><a href="#local-6989586621679399539"><span class="hs-identifier hs-var hs-var">validate_sender_canister_version</span></a></span></span><span> </span><span id="local-6989586621679399529"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399529"><span class="hs-identifier hs-var">call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-621"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; CanisterId
</span><a href="IC.Types.html#call_callee"><span class="hs-identifier hs-var">call_callee</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399529"><span class="hs-identifier hs-var">call</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399543"><span class="hs-identifier hs-var">subs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; String
</span><a href="IC.Types.html#call_method_name"><span class="hs-identifier hs-var">call_method_name</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399529"><span class="hs-identifier hs-var">call</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679399530"><span class="hs-identifier hs-var">sender_canister_version_methods</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-622"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. (a ~ SenderCanisterVersion) =&gt; Blob -&gt; Maybe Word64
</span><a href="IC.Ref.html#fetchSenderCanisterVersion"><span class="hs-identifier hs-var">fetchSenderCanisterVersion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Blob
</span><a href="IC.Types.html#call_arg"><span class="hs-identifier hs-var">call_arg</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399529"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-623"></span><span>          </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>          </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679399526"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399526"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-625"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399526"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399541"><span class="hs-identifier hs-var">sender_canister_version</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-626"></span><span>              </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Canister must set sender_canister_version matching ic0.canister_version&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span id="local-6989586621679401255"><span class="annot"><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-type">newCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401255"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401255"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-629"></span><span id="newCall"><span class="annot"><span class="annottext">newCall :: forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; Word64 -&gt; MethodCall -&gt; m ()
</span><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-var hs-var">newCall</span></a></span></span><span> </span><span id="local-6989586621679399491"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399491"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679399490"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399490"><span class="hs-identifier hs-var">sender_canister_version_from_system</span></a></span></span><span> </span><span id="local-6989586621679399489"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>  </span><span id="local-6989586621679399488"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399488"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399491"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span><span>
</span><span id="line-631"></span><span>  </span><span id="local-6989586621679399487"><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399487"><span class="hs-identifier hs-var">subs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679399486"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399486"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubnetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399486"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; [Subnet]
</span><a href="IC.Ref.Types.html#subnets"><span class="hs-identifier hs-var">subnets</span></a></span><span>
</span><span id="line-632"></span><span>  </span><span id="local-6989586621679399485"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399485"><span class="hs-identifier hs-var">is_on_root_subnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subnet -&gt; Bool
</span><a href="IC.Ref.Types.html#isRootSubnet"><span class="hs-identifier hs-var">isRootSubnet</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#find"><span class="hs-identifier hs-var">find</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubnetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399481"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679399481"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)] -&gt; CanisterId -&gt; Bool
</span><a href="IC.Id.Fresh.html#checkCanisterIdInRanges"><span class="hs-identifier hs-var">checkCanisterIdInRanges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679399481"><span class="hs-identifier hs-var">ranges</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399488"><span class="hs-identifier hs-var">canister_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; [Subnet]
</span><a href="IC.Ref.Types.html#subnets"><span class="hs-identifier hs-var">subnets</span></a></span><span>
</span><span id="line-633"></span><span>  </span><span id="local-6989586621679399479"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399479"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-634"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; CanisterId
</span><a href="IC.Types.html#call_callee"><span class="hs-identifier hs-var">call_callee</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-635"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; Callback -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-var">FromCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399491"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Callback
</span><a href="IC.Types.html#call_callback"><span class="hs-identifier hs-var">call_callback</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; Natural
</span><a href="IC.Types.html#call_transferred_cycles"><span class="hs-identifier hs-var">call_transferred_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-640"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-641"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MethodCall
-&gt; [CanisterId] -&gt; Bool -&gt; Word64 -&gt; Either (RejectCode, String) ()
</span><a href="IC.Ref.html#validate_call"><span class="hs-identifier hs-var">validate_call</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399487"><span class="hs-identifier hs-var">subs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399485"><span class="hs-identifier hs-var">is_on_root_subnet</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679399490"><span class="hs-identifier hs-var">sender_canister_version_from_system</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-642"></span><span>    </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679399477"><span class="annot"><span class="annottext">(RejectCode, String)
</span><a href="#local-6989586621679399477"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-643"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Response -&gt; m ()
</span><a href="IC.Ref.Types.html#respondCallContext"><span class="hs-identifier hs-var">respondCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399479"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RejectCode, String) -&gt; Response
</span><a href="IC.Types.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, String)
</span><a href="#local-6989586621679399477"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span>    </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-645"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.Types.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-646"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399479"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-647"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Blob -&gt; EntryPoint
</span><a href="IC.Ref.Types.html#Public"><span class="hs-identifier hs-var">Public</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; String
</span><a href="IC.Types.html#call_method_name"><span class="hs-identifier hs-var">call_method_name</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Blob
</span><a href="IC.Types.html#call_arg"><span class="hs-identifier hs-var">call_arg</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679399489"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-648"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span class="hs-comment">-- Scheduling</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span class="hs-comment">-- | Pick next request in state `received`</span><span>
</span><span id="line-653"></span><span id="local-6989586621679401231"><span class="annot"><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-type">nextReceived</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401231"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401231"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-654"></span><span id="nextReceived"><span class="annot"><span class="annottext">nextReceived :: forall (m :: * -&gt; *).
ICM m =&gt;
m (Maybe (Blob, CallRequest, CanisterId))
</span><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-var hs-var">nextReceived</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399472"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399472"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-655"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399470"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679399469"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399468"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399470"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679399470"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399469"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679399469"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399468"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399468"><span class="hs-identifier hs-var">ecid</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Blob &#8614; (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399472"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span class="hs-comment">-- A call context is still waiting for a response if&#8230;</span><span>
</span><span id="line-658"></span><span class="annot"><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-type">willReceiveResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-659"></span><span id="willReceiveResponse"><span class="annot"><span class="annottext">willReceiveResponse :: IC -&gt; CallId -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var hs-var">willReceiveResponse</span></a></span></span><span> </span><span id="local-6989586621679399466"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399466"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span id="local-6989586621679399465"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399465"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399465"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span>
</span><span id="line-660"></span><span>  </span><span class="hs-comment">-- there is another call context promising to respond to this</span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399464"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallContext -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679399464"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399464"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Callback
</span><span class="hs-identifier">_</span></span><span class="hs-special">}</span><span>
</span><span id="line-663"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">M.elems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399466"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-comment">-- there is an in-flight call message:</span><span>
</span><span id="line-666"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399462"><span class="hs-identifier hs-var">c'</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span> </span><span id="local-6989586621679399462"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399462"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#toList"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399466"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-667"></span><span>  </span><span class="hs-comment">-- there is an in-flight response message:</span><span>
</span><span id="line-668"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399460"><span class="hs-identifier hs-var">c''</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ResponseMessage"><span class="hs-identifier hs-type">ResponseMessage</span></a></span><span> </span><span id="local-6989586621679399459"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399459"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Response
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#toList"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399466"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679399460"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399460"><span class="hs-identifier hs-var">c''</span></a></span></span><span> </span><span class="annot"><span class="annottext">Callback
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallContext -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399459"><span class="hs-identifier hs-var">c'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399466"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-669"></span><span>  </span><span class="hs-comment">-- there this canister is waiting for some canister to stop</span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399457"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-671"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679399456"><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679399456"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">M.elems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399466"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399457"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399457"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679399456"><span class="hs-identifier hs-var">pending</span></a></span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-674"></span><span>  </span><span class="hs-comment">-- NB: this could be implemented more efficient if kepts a counter of</span><span>
</span><span id="line-675"></span><span>  </span><span class="hs-comment">-- outstanding calls in each call context</span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span class="hs-comment">-- | Find a starved call context</span><span>
</span><span id="line-678"></span><span id="local-6989586621679401224"><span class="annot"><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-type">nextStarved</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401224"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401224"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-679"></span><span id="nextStarved"><span class="annot"><span class="annottext">nextStarved :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CallId)
</span><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-var hs-var">nextStarved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399451"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399451"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399450"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399450"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399450"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399451"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-682"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; CallId -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var">willReceiveResponse</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399451"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399450"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-683"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span id="local-6989586621679399449"><span class="annot"><a href="IC.Ref.html#nextRemoved"><span class="hs-identifier hs-type">nextRemoved</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399449"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399449"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-686"></span><span id="nextRemoved"><span class="annot"><span class="annottext">nextRemoved :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CallId)
</span><a href="IC.Ref.html#nextRemoved"><span class="hs-identifier hs-var hs-var">nextRemoved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399444"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399444"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399443"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399443"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399443"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399444"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; CallId -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var">willReceiveResponse</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399444"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399443"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-690"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span class="hs-comment">-- | Find a canister in stopping state that is, well, stopped</span><span>
</span><span id="line-693"></span><span id="local-6989586621679401221"><span class="annot"><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-type">nextStoppedCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401221"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401221"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-694"></span><span id="nextStoppedCanister"><span class="annot"><span class="annottext">nextStoppedCanister :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CanisterId)
</span><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-var hs-var">nextStoppedCanister</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399436"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399436"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399435"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399435"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399435"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399436"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-comment">-- no call context still waiting for a response</span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399433"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399433"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399432"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679399432"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CallId &#8614; CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399436"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679399432"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399435"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span class="hs-comment">-- | Pick (and remove) next message from queue</span><span>
</span><span id="line-706"></span><span id="local-6989586621679401218"><span class="annot"><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-type">popMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-707"></span><span id="popMessage"><span class="annot"><span class="annottext">popMessage :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe Message)
</span><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-var hs-var">popMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399427"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399427"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399427"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-709"></span><span>    </span><span class="annot"><span class="annottext">Seq Message
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Sequence.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399427"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-710"></span><span>    </span><span id="local-6989586621679399425"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679399425"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Sequence.Internal.html#%3A%3C%7C"><span class="hs-operator hs-type">:&lt;|</span></a></span><span> </span><span id="local-6989586621679399423"><span class="annot"><span class="annottext">Seq Message
</span><a href="#local-6989586621679399423"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679399425"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399427"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">messages :: Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seq Message
</span><a href="#local-6989586621679399423"><span class="hs-identifier hs-var">ms</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span class="hs-comment">-- | Fake time increase</span><span>
</span><span id="line-713"></span><span id="local-6989586621679399422"><span class="annot"><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-type">bumpTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-714"></span><span id="bumpTime"><span class="annot"><span class="annottext">bumpTime :: forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-var hs-var">bumpTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-glyph">\</span><span id="local-6989586621679399414"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399414"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399414"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#map"><span class="hs-identifier hs-var">M.map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679399412"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399412"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399412"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.Types.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Timestamp
</span><a href="IC.Ref.Types.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399412"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Timestamp
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399414"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span id="local-6989586621679401212"><span class="annot"><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier hs-type">setAllTimesTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401212"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401212"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-718"></span><span id="setAllTimesTo"><span class="annot"><span class="annottext">setAllTimesTo :: forall (m :: * -&gt; *). ICM m =&gt; Timestamp -&gt; m ()
</span><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier hs-var hs-var">setAllTimesTo</span></a></span></span><span> </span><span id="local-6989586621679399407"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679399407"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-glyph">\</span><span id="local-6989586621679399406"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399406"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399406"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#map"><span class="hs-identifier hs-var">M.map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679399405"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399405"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399405"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.Types.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679399407"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679399406"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span id="local-6989586621679399404"><span class="annot"><a href="IC.Ref.html#runHeartbeat"><span class="hs-identifier hs-type">runHeartbeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399404"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399404"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-722"></span><span id="runHeartbeat"><span class="annot"><span class="annottext">runHeartbeat :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runHeartbeat"><span class="hs-identifier hs-var hs-var">runHeartbeat</span></a></span></span><span> </span><span id="local-6989586621679399374"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399374"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-723"></span><span>  </span><span id="local-6989586621679399373"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399373"><span class="hs-identifier hs-var">can</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanState
</span><a href="IC.Ref.Types.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399374"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-724"></span><span>  </span><span id="local-6989586621679399371"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399371"><span class="hs-identifier hs-var">is_empty</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399374"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-725"></span><span>  </span><span id="local-6989586621679399370"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399370"><span class="hs-identifier hs-var">is_running</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var">isCanisterRunning</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399374"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-726"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe EntryPoint -&gt; Bool
</span><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-var">idleSinceLastHeartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe EntryPoint
</span><a href="IC.Ref.Types.html#last_action"><span class="hs-identifier hs-var">last_action</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679399373"><span class="hs-identifier hs-var">can</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399371"><span class="hs-identifier hs-var">is_empty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399370"><span class="hs-identifier hs-var">is_running</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>    </span><span id="local-6989586621679399368"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399368"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-728"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399374"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-729"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallOrigin
</span><a href="IC.Ref.Types.html#FromSystemTask"><span class="hs-identifier hs-var">FromSystemTask</span></a></span><span>
</span><span id="line-730"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-731"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-732"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-733"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-734"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-735"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-736"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399368"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-737"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#Heartbeat"><span class="hs-identifier hs-var">Heartbeat</span></a></span><span>
</span><span id="line-738"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span id="local-6989586621679399367"><span class="annot"><a href="IC.Ref.html#runGlobalTimer"><span class="hs-identifier hs-type">runGlobalTimer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-741"></span><span id="runGlobalTimer"><span class="annot"><span class="annottext">runGlobalTimer :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runGlobalTimer"><span class="hs-identifier hs-var hs-var">runGlobalTimer</span></a></span></span><span> </span><span id="local-6989586621679399324"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-742"></span><span>  </span><span id="local-6989586621679399323"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399323"><span class="hs-identifier hs-var">is_empty</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-743"></span><span>  </span><span id="local-6989586621679399322"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399322"><span class="hs-identifier hs-var">is_running</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var">isCanisterRunning</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-744"></span><span>  </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679399321"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399321"><span class="hs-identifier hs-var">current_time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Timestamp
</span><a href="IC.Ref.Types.html#getCanisterTime"><span class="hs-identifier hs-var">getCanisterTime</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-745"></span><span>  </span><span id="local-6989586621679399319"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399319"><span class="hs-identifier hs-var">global_timer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCanisterGlobalTimer"><span class="hs-identifier hs-var">getCanisterGlobalTimer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399317"><span class="annot"><span class="annottext">should_fire :: Bool
</span><a href="#local-6989586621679399317"><span class="hs-identifier hs-var hs-var">should_fire</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399319"><span class="hs-identifier hs-var">global_timer</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399321"><span class="hs-identifier hs-var">current_time</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679399319"><span class="hs-identifier hs-var">global_timer</span></a></span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399317"><span class="hs-identifier hs-var">should_fire</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399322"><span class="hs-identifier hs-var">is_running</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399323"><span class="hs-identifier hs-var">is_empty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-748"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setCanisterGlobalTimer"><span class="hs-identifier hs-var">setCanisterGlobalTimer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-749"></span><span>    </span><span id="local-6989586621679399315"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399315"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-750"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679399324"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-751"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallOrigin
</span><a href="IC.Ref.Types.html#FromSystemTask"><span class="hs-identifier hs-var">FromSystemTask</span></a></span><span>
</span><span id="line-752"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-753"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-754"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe String
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-755"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-756"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-757"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-758"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679399315"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-759"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#GlobalTimer"><span class="hs-identifier hs-var">GlobalTimer</span></a></span><span>
</span><span id="line-760"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span id="local-6989586621679401266"><span class="annot"><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier hs-type">processSystemTasks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-763"></span><span id="processSystemTasks"><span class="annot"><span class="annottext">processSystemTasks :: forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier hs-var hs-var">processSystemTasks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-764"></span><span>  </span><span id="local-6989586621679399295"><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399295"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [k]
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/containers-0.6.5.1/src/Data.Map.Internal.html#keys"><span class="hs-identifier hs-var">M.keys</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; CanisterId &#8614; CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399295"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runHeartbeat"><span class="hs-identifier hs-var">runHeartbeat</span></a></span><span>
</span><span id="line-766"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679399295"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runGlobalTimer"><span class="hs-identifier hs-var">runGlobalTimer</span></a></span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span class="annot"><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-type">idleSinceLastHeartbeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-769"></span><span id="idleSinceLastHeartbeat"><span class="annot"><span class="annottext">idleSinceLastHeartbeat :: Maybe EntryPoint -&gt; Bool
</span><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-var hs-var">idleSinceLastHeartbeat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#Heartbeat"><span class="hs-identifier hs-var">Heartbeat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-770"></span><span class="annot"><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-var">idleSinceLastHeartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span class="hs-comment">-- | Returns true if a step was taken</span><span>
</span><span id="line-773"></span><span id="local-6989586621679401203"><span class="annot"><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-type">runStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-774"></span><span id="runStep"><span class="annot"><span class="annottext">runStep :: forall (m :: * -&gt; *). ICM m =&gt; m Bool
</span><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-var hs-var">runStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-775"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-var">bumpTime</span></a></span><span>
</span><span id="line-776"></span><span>  </span><span class="annot"><span class="annottext">[m Bool] -&gt; m Bool
</span><a href="#local-6989586621679399248"><span class="hs-identifier hs-var">try</span></a></span><span>
</span><span id="line-777"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679399247"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
m (Maybe (Blob, CallRequest, CanisterId))
</span><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-var">nextReceived</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ICM m =&gt;
(Blob, CallRequest, CanisterId) -&gt; m ()
</span><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-var">processRequest</span></a></span><span>
</span><span id="line-778"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679399247"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m (Maybe Message)
</span><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-var">popMessage</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span>
</span><span id="line-779"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679399247"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CallId)
</span><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-var">nextStarved</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m ()
</span><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-var">starveCallContext</span></a></span><span>
</span><span id="line-780"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679399247"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CallId)
</span><a href="IC.Ref.html#nextRemoved"><span class="hs-identifier hs-var">nextRemoved</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m ()
</span><a href="IC.Ref.html#removeCallContext"><span class="hs-identifier hs-var">removeCallContext</span></a></span><span>
</span><span id="line-781"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679399247"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CanisterId)
</span><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-var">nextStoppedCanister</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-var">actuallyStopCanister</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-783"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-784"></span><span>    </span><span id="local-6989586621679399248"><span class="annot"><span class="annottext">try :: [m Bool] -&gt; m Bool
</span><a href="#local-6989586621679399248"><span class="hs-identifier hs-var hs-var">try</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679399241"><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679399241"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679399240"><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679399240"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679399241"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679399240"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>    </span><span id="local-6989586621679399247"><span class="annot"><span class="annottext">with :: m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679399247"><span class="hs-identifier hs-var hs-var">with</span></a></span></span><span> </span><span id="local-6989586621679399234"><span class="annot"><span class="annottext">m (Maybe t)
</span><a href="#local-6989586621679399234"><span class="hs-identifier hs-var">sel</span></a></span></span><span> </span><span id="local-6989586621679399233"><span class="annot"><span class="annottext">t -&gt; m a
</span><a href="#local-6989586621679399233"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Maybe t)
</span><a href="#local-6989586621679399234"><span class="hs-identifier hs-var">sel</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679399231"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679399231"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; m a
</span><a href="#local-6989586621679399233"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679399231"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/ghc-prim-0.8.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span id="local-6989586621679399230"><span class="annot"><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier hs-type">runToCompletion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-788"></span><span id="runToCompletion"><span class="annot"><span class="annottext">runToCompletion :: forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier hs-var hs-var">runToCompletion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m ()
</span><a href="IC.Utils.html#repeatWhileTrue"><span class="hs-identifier hs-var">repeatWhileTrue</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ICM m =&gt; m Bool
</span><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-var">runStep</span></a></span><span>
</span><span id="line-789"></span></pre></body></html>
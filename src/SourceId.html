<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- |
This module exports a source id in a way that works well within a nix build (no
.git available) and outside nix, according to this logic:

 * If `git` works, use `git describe`
 * Else, if $out is set (so this is a nix build), extract an identifer from the out hash
 * Else, it says something like unidentified build.

This is an early experiment. If successful, this logic ought to move into a
library, and maybe also implemented for rust artifacts. (see RPL-101)

Note that cabal build will not recompile this module if it does not have to, so in local development, this is less reliable than it should. See
https://www.joachim-breitner.de/blog/772-Template_Haskell_recompilation
for more details.

-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-20"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SourceId</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/template-haskell-2.18.0.0/src/Language.Haskell.TH.html"><span class="hs-identifier">Language.Haskell.TH</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/5q21c0v4qr3765fg02ijndirlmrr4i1w-split-0.2.3.5-doc/share/doc/split-0.2.3.5/html/src/Data.List.Split.html"><span class="hs-identifier">Data.List.Split</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/process-1.6.16.0/src/System.Process.html"><span class="hs-identifier">System.Process</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/System.Environment.html"><span class="hs-identifier">System.Environment</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="annot"><a href="SourceId.html#id"><span class="hs-identifier hs-type">id</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/n4nbngkdp72aigvzs0xc8cy88z0ydbfv-ghc-9.2.8-doc/share/doc/ghc/html/libraries/base-4.16.4.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-31"></span><span id="id"><span class="annot"><span class="annottext">id :: String
</span><a href="SourceId.html#id"><span class="hs-identifier hs-var hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-identifier">stringE</span><span> </span><span class="hs-operator">&lt;=&lt;</span><span> </span><span class="hs-identifier">runIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-comment">-- Leniently calls git, and removes final newline from git&#8217;s output</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">readGit</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">lines</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">catch</span><span>
</span><span id="line-34"></span><span>            </span><span class="hs-special">(</span><span class="hs-identifier">readCreateProcess</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">proc</span><span> </span><span class="hs-string">&quot;git&quot;</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">std_err</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CreatePipe</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IOException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-identifier">inGit</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">readGit</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;rev-parse&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--is-inside-work-tree&quot;</span><span class="hs-special">]</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">inGit</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-string">&quot;true&quot;</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">readGit</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;describe&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--tags&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--match=v*&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;--dirty&quot;</span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">lookupEnv</span><span> </span><span class="hs-string">&quot;out&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-41"></span><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">path</span><span>
</span><span id="line-42"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span class="hs-string">&quot;nix&quot;</span><span class="hs-special">,</span><span class="hs-string">&quot;store&quot;</span><span class="hs-special">,</span><span class="hs-identifier">base</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">splitOn</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-identifier">path</span><span>
</span><span id="line-43"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">hash</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator">/=</span><span> </span><span class="hs-char">'-'</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">base</span><span>
</span><span id="line-44"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">intercalate</span><span> </span><span class="hs-string">&quot;-&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chunksOf</span><span> </span><span class="hs-number">8</span><span> </span><span class="hs-identifier">hash</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">path</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">fail</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-string">&quot;SouceId: unparsable $out=&quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">path</span><span>
</span><span id="line-46"></span><span>        </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-string">&quot;unidentified&quot;</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span></pre></body></html>